args:
  panel: &panel hdfs:///workData/Panel/test
  notPublishHosp: &notPublishHosp hdfs:///repository/not_published_hosp/5ca069bceeefcc012918ec72
  cleanCpa: &cleanCpa hdfs:///workData/Clean/cpa-test
  mkt: &mkt MARKET == '麻醉市场' AND SAMPLE == 1
  missHosp: &missHosp hdfs:///repository/miss_hosp/5ca069bceeefcc012918ec72
  cleanGycx: &cleanGycx hdfs:///workData/Clean/gycx-test
  max: &max hdfs:///workData/Max/test
  date: &date DATE == 201809
  sampleHosp: &sampleHosp hdfs:///repository/sample_hosp/5ca069bceeefcc012918ec72/mz
  jobId: &jobId test
  universe: &universe hdfs:///repository/universe_hosp/5ca069bceeefcc012918ec72/mz
  topic: &topic listeningJobTask
  ym: &ym YM == 201809
  companyId: &companyId '5ca069bceeefcc012918ec72'
  fullHosp: &fullHosp hdfs:///repository/full_hosp/5ca069bceeefcc012918ec72/20180629
  cpa: &cpa hdfs:///data/nhwa/pha_config_repository1809/Nhwa_201809_CPA_20181126.csv
name: max
factory: com.pharbers.ipaas.data.driver.api.factory.PhJobFactory
reference: com.pharbers.ipaas.data.driver.api.job.PhProgressJob
actions:
- name: readCpaFile
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: loadCpaFromCsv
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadCsvOperator
    args:
      path: *cpa
      delimiter: ","
  - name: hospIdCastInt
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: loadCpaFromCsv
      newColName: HOSP_ID
    plugin:
      name: castInt
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: cast(HOSP_ID as int)
- name: readHospitalFile
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: loadHospitalFile
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/hosp_dis_max
- name: readProductFile
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: loadProductFile
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/prod_etc_dis_max/5ca069bceeefcc012918ec72
  - name: concantMin2
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: loadProductFile
      newColName: min2
    plugin:
      name: concatMin2
      reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      args:
        columns: ETC_PRODUCT_NAME#ETC_DOSAGE_NAME#ETC_PACKAGE_DES#ETC_PACKAGE_NUMBER#ETC_CORP_NAME
        dilimiter: ""
  - name: productSelect
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: concantMin2
      selects: DEV_PRODUCT_ID as PRODUCT_ID#regexp_replace(min2, " ", "") as min2
- name: readPhaFile
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: loadPhaFile
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: hdfs:///repository/pha
- name: readProductMatchFile
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: loadProductMatchFile
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadCsvOperator
    args:
      path: hdfs:///data/nhwa/pha_config_repository1809/Nhwa_ProductMatchTable_20181126.csv
      delimiter: ","
  - name: productMatchSelect
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: loadProductMatchFile
      selects: regexp_replace(MIN_PRODUCT_UNIT, " ", "") as MIN_PRODUCT_UNIT#regexp_replace(MIN_PRODUCT_UNIT_STANDARD, " ", "") as MIN_PRODUCT_UNIT_STANDARD
- name: distinctHosp
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: hospitalSelect
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: readHospitalFile
      selects: HOSPITAL_ID#PHA_HOSP_ID
  - name: distinctByKey
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
    args:
      inDFName: hospitalSelect
      keys: PHA_HOSP_ID
- name: distinctPha
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: phaSelect
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: readPhaFile
      selects: CPA#PHA_ID_NEW
  - name: hospIdCastInt
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: phaSelect
      newColName: CPA
    plugin:
      name: castInt
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: cast(CPA as int)
  - name: DistinctByCpa
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
    args:
      inDFName: hospIdCastInt
      keys: CPA
- name: cpaMatchHosp
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: joinPha
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: readCpaFile
      joinDFName: distinctPha
      joinExpr: HOSP_ID = CPA
      joinType: left
  - name: joinHosp
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: joinPha
      joinDFName: distinctHosp
      joinExpr: PHA_ID_NEW = PHA_HOSP_ID
      joinType: left
  - name: addHospId
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: joinHosp
      newColName: HOSPITAL_ID
    plugin:
      name: fillHospId
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: case when HOSPITAL_ID is not null then HOSPITAL_ID else concat("other", HOSP_ID) end
- name: cpaMatchProduct
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: concantMin1
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: cpaMatchHosp
      newColName: min1
    plugin:
      name: concatMin1
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
      args:
        columns: PRODUCT_NAME#DOSAGE#PACK_DES#PACK_NUMBER#CORP_NAME
        dilimiter: ""
  - name: regexpReplaceMin1
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: concantMin1
      newColName: min1
    plugin:
      name: regexpReplaceMin1
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: regexp_replace(min1, " ", "")
  - name: joinProductMatch
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: regexpReplaceMin1
      joinDFName: readProductMatchFile
      joinExpr: min1 = MIN_PRODUCT_UNIT
      joinType: left
  - name: joinProduct
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: joinProductMatch
      joinDFName: readProductFile
      joinExpr: MIN_PRODUCT_UNIT_STANDARD = min2
      joinType: left
- name: cleanResult
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: litCompanyId
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: cpaMatchProduct
      newColName: COMPANY_ID
    plugin:
      name: litCompanyId
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: *companyId
  - name: litSOURCE
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: litCompanyId
      newColName: SOURCE
    plugin:
      name: litSOURCE
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: "'CPA'"
  - name: litProductNameNote
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: litSOURCE
      newColName: PRODUCT_NAME_NOTE
    plugin:
      name: litProductNameNote
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: "''"
  - name: addYM
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: litProductNameNote
      newColName: YM
    plugin:
      name: addYM
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.MergeYMPlugin
      args:
        yearColName: YEAR
        monthColName: MONTH
  - name: SelectKeepCol
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: addYM
      selects: COMPANY_ID#SOURCE#YM#HOSPITAL_ID#PRODUCT_ID#cast(VALUE as double) as SALES#cast(STANDARD_UNIT as double) as UNITS#PRODUCT_NAME_NOTE
  - name: genCleanId
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: SelectKeepCol
      newColName: _id
    plugin:
      name: generateObjectId
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.GenerateObjectIdPlugin
  - name: saveCleanCpa
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SaveParquetOperator
    args:
      inDFName: genCleanId
      path: *cleanCpa



- name: readCpa
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: *cleanCpa

- name: readMissHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: *missHospPath

- name: readNotPublishHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: *notPublishHosp

- name: readFullHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: *fullHosp

- name: readSampleHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: read
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: *sampleHosp

- name: missHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: readMissHosp
      filter: *date
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: filter
      drops: DATE
  - name: union
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.UnionOperator
    args:
      inDFName: drop
      unionDFName: readNotPublishHosp
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: union
      drops: _id
  - name: distinct
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DistinctOperator
    args:
      inDFName: drop
  - name: rename
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: distinct
      oldColName: HOSPITAL_ID
      newColName: MISS_HOSPITAL_ID

- name: primalCpa
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: readCpa
      filter: *ym

- name: reducedCpa
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: join
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: primalCpa
      joinDFName: missHosp
      joinExpr: MISS_HOSPITAL_ID == HOSPITAL_ID
      joinType: left
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: join
      filter: MISS_HOSPITAL_ID IS NULL
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: filter
      drops: MISS_HOSPITAL_ID

- name: cpa
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: readFullHosp
      filter: *ym
  - name: join
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: filter
      joinDFName: missHosp
      joinExpr: MISS_HOSPITAL_ID == HOSPITAL_ID
      joinType: inner
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: join
      drops: MISS_HOSPITAL_ID
  - name: union
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.UnionOperator
    args:
      inDFName: drop
      unionDFName: reducedCpa

- name: sampleHosp
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: filter
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: readSampleHosp
      filter: *mkt
  - name: rename
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: filter
      oldColName: HOSPITAL_ID
      newColName: SAMPLE_HOSPITAL_ID

- name: panelResult
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: join
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: cpa
      joinDFName: sampleHosp
      joinExpr: SAMPLE_HOSPITAL_ID == HOSPITAL_ID
      joinType: inner
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: join
      drops: SAMPLE_HOSPITAL_ID
  - name: concant
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: drop
      newColName: GROUP
    plugin:
      name: concat
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
      args:
        columns: COMPANY_ID#YM#HOSPITAL_ID#PRODUCT_ID
        dilimiter: "#"
  - name: group
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.GroupOperator
    args:
      inDFName: concant
      groups: GROUP
      aggExprs: sum(UNITS) as UNITS#sum(SALES) as SALES#first(COMPANY_ID) as COMPANY_ID#first(YM) as YM#first(HOSPITAL_ID) as HOSPITAL_ID#first(PRODUCT_ID) as PRODUCT_ID
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: group
      drops: GROUP
  - name: savlePanel
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SaveParquetOperator
    args:
      inDFName: drop
      path: *panel




- name: panelData
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: readParquet
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: *panel
- name: universeData
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: readCsv
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ReadParquetOperator
    args:
      path: *universe
- name: universeDF
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: dropId
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: universeData
      drops: _id
  - name: withColumnRenamedIS_PANEL_HOSP
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: dropId
      oldColName: IF_PANEL_ALL
      newColName: IS_PANEL_HOSP
  - name: withColumnRenamedNEED_MAX_HOSP
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: withColumnRenamedIS_PANEL_HOSP
      oldColName: IF_PANEL_TO_USE
      newColName: NEED_MAX_HOSP

- name: panelSummed
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: concant
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: panelData
      newColName: GROUP
    plugin:
      name: concat
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
      args:
        columns: YM#HOSPITAL_ID#PRODUCT_ID
        dilimiter: +
  - name:  group
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.GroupOperator
    args:
      inDFName: concant
      groups: GROUP
      aggExprs: sum(UNITS) as sumUnits#sum(SALES) as sumSales#first(YM) as P_YM#first(HOSPITAL_ID) as P_HOSPITAL_ID#first(PRODUCT_ID) as P_PRODUCT_ID
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: group
      drops: GROUP

- name: joinDataWithEmptyValue
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: select
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: panelData
      selects: YM#PRODUCT_ID
  - name: distinctByKey
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DistinctByKeyOperator
    args:
      inDFName: select
      keys: YM#PRODUCT_ID
  - name: cross
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: distinctByKey
      joinDFName: universeDF
      joinExpr: TRUE
      joinType: cross

- name: joinData
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  opers:
  - name: JoinOperator
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: joinDataWithEmptyValue
      joinDFName: panelSummed
      joinExpr: HOSPITAL_ID == P_HOSPITAL_ID AND YM == P_YM AND PRODUCT_ID == P_PRODUCT_ID
      joinType: left
  - name: fillNullSales
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: JoinOperator
      newColName: j_sumSales
    plugin:
      name: FillColumnPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.WhenPlugin
      args:
        condition: "sumSales IS NULL"
        value: 0.0
      sub:
        name: FillColumnPlugin
        factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
        reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
        args:
          exprString: "sumSales"
  - name: fillNullUnits
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: fillNullSales
      newColName: j_sumUnits
    plugin:
      name: FillColumnPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.WhenPlugin
      args:
        condition: "sumUnits IS NULL"
        value: 0.0
      sub:
        name: FillColumnPlugin
        factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
        reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
        args:
          exprString: "sumUnits"
  - name: drop sumSales,sumUnits
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: fillNullUnits
      drops: sumSales#sumUnits
  - name: withColumnRenamedSumSales
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: drop sumSales,sumUnits
      oldColName: j_sumSales
      newColName: sumSales
  - name: withColumnRenamedSumUnits
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: withColumnRenamedSumSales
      oldColName: j_sumUnits
      newColName: sumUnits

- name: segmentDF
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: filtered
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: joinData
      filter: NEED_MAX_HOSP == 1
  - name: concant
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: filtered
      newColName: GROUP
    plugin:
      name: concat
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ConcatStrPlugin
      args:
        columns: SEGMENT#PRODUCT_ID#YM
        dilimiter: +
  - name: group
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.GroupOperator
    args:
      inDFName: concant
      groups: GROUP
      aggExprs: sum(sumSales) as s_sumSales#sum(sumUnits) as s_sumUnits#sum(WEST_MEDICINE_INCOME) as s_westMedicineIncome#first(SEGMENT) as SEGMENT#first(PRODUCT_ID) as PRODUCT_ID#first(YM) as YM
  - name: drop
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: group
      drops: GROUP
  - name: withColumnRenameds_SEGMENT
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: drop
      oldColName: SEGMENT
      newColName: s_SEGMENT
  - name: withColumnRenameds_PRODUCT_ID
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: withColumnRenameds_SEGMENT
      oldColName: PRODUCT_ID
      newColName: s_PRODUCT_ID
  - name: withColumnRenameds_YM
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: withColumnRenameds_PRODUCT_ID
      oldColName: YM
      newColName: s_YM
  - name: avg_Sales
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: withColumnRenameds_YM
      newColName: avg_Sales
    plugin:
      name: BaseCalcPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: s_sumSales / s_westMedicineIncome
  - name: avg_Units
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: avg_Sales
      newColName: avg_Units
    plugin:
      name: BaseCalcPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: s_sumUnits / s_westMedicineIncome
  - name: drop s_sumSales,s_sumUnits,s_westMedicineIncome
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: avg_Units
      drops: s_sumSales#s_sumUnits#s_westMedicineIncome

- name: enlargedDF
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: join
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: joinData
      joinDFName: segmentDF
      joinExpr: SEGMENT == s_SEGMENT AND PRODUCT_ID == s_PRODUCT_ID AND YM == s_YM
      joinType: inner
  - name: drop s_SEGMENT,s_PRODUCT_ID,s_YM
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: join
      drops: s_SEGMENT,s_PRODUCT_ID,s_YM
  - name: cast String to Int
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: drop s_SEGMENT,s_PRODUCT_ID,s_YM
      newColName: Factor
    plugin:
      name: BaseCalcPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: Factor as Double
  - name: filter factor
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: cast String to Int
      filter: Factor > 0.0
  - name: addCol f_sales
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: filter factor
      newColName: f_sales
    plugin:
      name: BaseCalcPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: case when IS_PANEL_HOSP == 1 then sumSales when avg_Sales <= 0.0 or avg_Units  <= 0.0 then 0.0 else WEST_MEDICINE_INCOME * Factor * avg_Sales  end
  - name: cast String to Double
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: addCol f_sales
      newColName: f_sales
    plugin:
      name: BaseCalcPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: f_sales as Double
  - name: addCol f_units
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: cast String to Double
      newColName: f_units
    plugin:
      name: BaseCalcPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: case when IS_PANEL_HOSP == 1 then sumUnits when avg_Sales <= 0.0 or avg_Units  <= 0.0 then 0.0 else WEST_MEDICINE_INCOME * avg_Units * Factor end
  - name: cast String to Double
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: addCol f_units
      newColName: f_units
    plugin:
      name: BaseCalcPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: f_units as Double
  - name: drop s_sumSales,s_sumUnits,s_westMedicineIncome
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.DropOperator
    args:
      inDFName: cast String to Double
      drops: s_sumSales,s_sumUnits,s_westMedicineIncome
  - name: filter IS_PANEL_HOSP
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.ExprFilterOperator
    args:
      inDFName: drop s_sumSales,s_sumUnits,s_westMedicineIncome
      filter: IS_PANEL_HOSP == 0 AND (f_units != 0.0 AND f_sales != 0.0)
  - name: cast String to Int
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: filter IS_PANEL_HOSP
      newColName: Date
    plugin:
      name: BaseCalcPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: YM as Int
  - name: select
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: cast String to Int
      selects: Date#HOSPITAL_ID#PRODUCT_ID#f_units#f_sales

- name: backfillDF
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: WithColumnRenamedP_HOSPITAL_ID
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: panelData
      oldColName: HOSPITAL_ID
      newColName: P_HOSPITAL_ID
  - name: join
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.JoinOperator
    args:
      inDFName: WithColumnRenamedP_HOSPITAL_ID
      joinDFName: universeDF
      joinExpr: P_HOSPITAL_ID == HOSPITAL_ID
      joinType: inner
  - name: addColumn
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.AddColumnOperator
    args:
      inDFName: join
      newColName: Date
    plugin:
      name: BaseCalcPlugin
      factory: com.pharbers.ipaas.data.driver.api.factory.PhPluginFactory
      reference: com.pharbers.ipaas.data.driver.plugins.ExprPlugin
      args:
        exprString: YM as Int
  - name: WithColumnRenamedf_sales
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: addColumn
      oldColName: Sales
      newColName: f_sales
  - name: WithColumnRenamedf_units
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.WithColumnRenamedOperator
    args:
      inDFName: WithColumnRenamedf_sales
      oldColName: Units
      newColName: f_units
  - name: select
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SelectOperator
    args:
      inDFName: WithColumnRenamedf_units
      selects: Date#HOSPITAL_ID#PRODUCT_ID#f_units#f_sales

- name: maxResult
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: union
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.UnionOperator
    args:
      inDFName: backfillDF
      unionDFName: enlargedDF
- name: saveMax
  factory: com.pharbers.ipaas.data.driver.api.factory.PhActionFactory
  reference: com.pharbers.ipaas.data.driver.api.job.PhBaseAction
  opers:
  - name: saveMax
    factory: com.pharbers.ipaas.data.driver.api.factory.PhOperatorFactory
    reference: com.pharbers.ipaas.data.driver.operators.SaveParquetOperator
    args:
      inDFName: maxResult
      path: *max

